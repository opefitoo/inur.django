<!DOCTYPE html>
<html lang='en'>
<head>
    <style>
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    <meta charset='utf-8'/>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css"
          integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <script>

        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        }


        function updateEvent(event) {
            console.log("event =" + event);
            console.log("event id =" + event.id);
            $.ajax({
                url: '/api/v1/fullcalendar-events/',
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: event.id,
                    title: event.title,
                    start: event.start,
                    end: event.end
                }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.setRequestHeader('Authorization', 'Token ' + localStorage.getItem('token'));
                },
                success: function (response) {
                    console.log('Event updated successfully:', response);
                },
                error: function (response) {
                    console.error('Error updating event:', response);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'bootstrap5',
                initialView: 'timeGridWeek',
                editable: true,
                eventResizableFromStart: false,
                locale: 'fr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                firstDay: 1,
                droppable: true,
                editable: true,
                snapDuration: moment.duration(15, 'minutes'),
                nowIndicator: true,
                timeZone: 'Europe/Paris',
                businessHours: {
                    startTime: '06:00',
                    endTime: '22:30',
                    dow: [1, 2, 3, 4, 5, 6, 7]
                },
                weekends: {
                    // display weekends in a different color
                    color: 'blue'
                },
                eventDrop: function (info) {
                    updateEvent(info.event);
                    console.log(info.event.start.toISOString());
                },
                eventResize: function (info) {
                    updateEvent(info.event);
                    console.log(info.event.end.toISOString());
                },
                eventSources: [{
                    failure: function () {

                    },
                    events: function (info, successCallback, failureCallback) {
                        $.ajax({
                            url: '/api/v1/fullcalendar-events/',
                            type: 'GET',
                            data: {
                                start: info.startStr,
                                end: info.endStr
                            },
                            beforeSend: function () {
                                $('.loading-spinner').show();
                            },
                            success: function (events) {
                                $('.loading-spinner').hide();
                                for (let i = 0; i < events.length; i++) {
                                    console.log(events[i].backgroundColor);
                                    console.log(events[i].title);
                                    events[i].color = events[i].color;
                                    events[i].textColor = events[i].textcolor;
                                }
                                successCallback(events);
                            },
                            error: function () {
                                $('.loading-spinner').hide();
                                failureCallback();
                            },
                            failure: function () {
                                $('.loading-spinner').hide();
                                failureCallback();
                            },
                            datesRender: function (info) {
                                calendar.refetchEvents();
                            }
                        });
                    }
                }],
            });

            calendar.render();
        });

    </script>
</head>
<body>
<!-- Loading spinner -->
<div class="loading-spinner">
    <p>Loading...</p>
    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
</div>
<div id='calendar'></div>
</body>
</html>
